///////////////////////////////////////////////////////////
// This module is to look at beam halos using tight      //
// photons. So this module must be identical to          //
// HaloByCutsTemp_Ele.cc/hh except select photons instead//
// of electrons. --  01-09-2008                          //
// use this to study beam halos                          //
///////////////////////////////////////////////////////////
// Author: Samantha K. Hewamanage <samantha@fnal.gov>


#include "samantha/Pho/HaloEstimate.hh"
#include "Stntuple/loop/TStnAna.hh"
#include "Stntuple/obj/TStnPhoton.hh"
#include <iostream>

ClassImp(HaloEstimate)

//_____________________________________________________________________________
HaloEstimate::HaloEstimate(const char* name, const char* title):
  TStnModule(name,title),
  qMc(false),
  bRunPermit(true)
{
	std::cout << "Hello I am HaloEstimate module" << std::endl;
}

//_____________________________________________________________________________
HaloEstimate::~HaloEstimate() {
}

//_____________________________________________________________________________
void HaloEstimate::SaveHistograms() {
}

//_____________________________________________________________________________
void HaloEstimate::BookHistograms()
{
	DeleteHistograms();
  	char name [200];
  	char title[200];
	TFolder* new_folder = GetHistFolder(this, "1Jet"," >=1 Jets Case");
	
	if (!new_folder) {
		StdErr(__FILE__,__LINE__,3,"Request for a new Histogram Folder returned NULL. No histograms are added.");
		bRunPermit = false;
		return;
	} else {
		// assume the first check is enough for null older etc..
		Histograms HistoMan;
		
		TFolder *sub_folder = new_folder->AddFolder("Scene0","Scene0");
		HistoMan.GetHaloHistograms(sub_folder,halo1js0,"Halo Scenario 0,  >=1 Jets");
		TFolder *subsub_folder = sub_folder->AddFolder("PhiWedge0_23","PhiWedge0_23");
		BookPhiWedgeHistograms(halo1js0pw023,subsub_folder,"Halo Scenario 0,  >=1 Jets, #Phi wedge 0,23");
		subsub_folder = sub_folder->AddFolder("PhiWedge1_22","PhiWedge1_22");
		BookPhiWedgeHistograms(halo1js0pw122,subsub_folder,"Halo Scenario 0,  >=1 Jets, #Phi wedge 1-22");
	
		sub_folder = new_folder->AddFolder("Scene1","Scene1");
		HistoMan.GetHaloHistograms(sub_folder,halo1js1,"Halo Scenario 1,  >=1 Jets");
		subsub_folder = sub_folder->AddFolder("PhiWedge0_23","PhiWedge0_23");
		BookPhiWedgeHistograms(halo1js1pw023,subsub_folder,"Halo Scenario 1,  >=1 Jets, #Phi wedge 0,23");
		subsub_folder = sub_folder->AddFolder("PhiWedge1_22","PhiWedge1_22");
		BookPhiWedgeHistograms(halo1js1pw122,subsub_folder,"Halo Scenario 1,  >=1 Jets, #Phi wedge 1-22");
	
		sub_folder = new_folder->AddFolder("Scene2","Scene2");
		HistoMan.GetHaloHistograms(sub_folder,halo1js2,"Halo Scenario 2,  >=1 Jets");
		subsub_folder = sub_folder->AddFolder("PhiWedge0_23","PhiWedge0_23");
		BookPhiWedgeHistograms(halo1js2pw023,subsub_folder,"Halo Scenario 2,  >=1 Jets, #Phi wedge 0,23");
		subsub_folder = sub_folder->AddFolder("PhiWedge1_22","PhiWedge1_22");
		BookPhiWedgeHistograms(halo1js2pw122,subsub_folder,"Halo Scenario 2,  >=1 Jets, #Phi wedge 1-22");
	
		sub_folder = new_folder->AddFolder("Scene3","Scene3");
		HistoMan.GetHaloHistograms(sub_folder,halo1js3,"Halo Scenario 3,  >=1 Jets");
		subsub_folder = sub_folder->AddFolder("PhiWedge0_23","PhiWedge0_23");
		BookPhiWedgeHistograms(halo1js3pw023,subsub_folder,"Halo Scenario 3,  >=1 Jets, #Phi wedge 0,23");
		subsub_folder = sub_folder->AddFolder("PhiWedge1_22","PhiWedge1_22");
		BookPhiWedgeHistograms(halo1js3pw122,subsub_folder,"Halo Scenario 3,  >=1 Jets, #Phi wedge 1-22");
	
		sub_folder = new_folder->AddFolder("Scene4","Scene4");
		HistoMan.GetHaloHistograms(sub_folder,halo1js4,"Halo Scenario 4,  >=1 Jets");
		subsub_folder = sub_folder->AddFolder("PhiWedge0_23","PhiWedge0_23");
		BookPhiWedgeHistograms(halo1js4pw023,subsub_folder,"Halo Scenario 4,  >=1 Jets, #Phi wedge 0,23");
		subsub_folder = sub_folder->AddFolder("PhiWedge1_22","PhiWedge1_22");
		BookPhiWedgeHistograms(halo1js4pw122,subsub_folder,"Halo Scenario 4,  >=1 Jets, #Phi wedge 1-22");
	
		sub_folder = new_folder->AddFolder("Scene5","Scene5");
		HistoMan.GetHaloHistograms(sub_folder,halo1js5,"Halo Scenario 5,  >=1 Jets");
		subsub_folder = sub_folder->AddFolder("PhiWedge0_23","PhiWedge0_23");
		BookPhiWedgeHistograms(halo1js5pw023,subsub_folder,"Halo Scenario 5,  >=1 Jets, #Phi wedge 0,23");
		subsub_folder = sub_folder->AddFolder("PhiWedge1_22","PhiWedge1_22");
		BookPhiWedgeHistograms(halo1js5pw122,subsub_folder,"Halo Scenario 5,  >=1 Jets, #Phi wedge 1-22");
	
		// >=2 Jets case 
		new_folder = GetHistFolder(this, "2Jet","2 Jet Case");

		sub_folder = new_folder->AddFolder("Scene0","Scene0");
		HistoMan.GetHaloHistograms(sub_folder,halo2js0,"Halo Scenario 0, >=2 Jets");
		subsub_folder = sub_folder->AddFolder("PhiWedge0_23","PhiWedge0_23");
		BookPhiWedgeHistograms(halo2js0pw023,subsub_folder,"Halo Scenario 0, >=2 Jets, #Phi wedge 0,23");
		subsub_folder = sub_folder->AddFolder("PhiWedge1_22","PhiWedge1_22");
		BookPhiWedgeHistograms(halo2js0pw122,subsub_folder,"Halo Scenario 0, >=2 Jets, #Phi wedge 1-22");
	
		sub_folder = new_folder->AddFolder("Scene1","Scene1");
		HistoMan.GetHaloHistograms(sub_folder,halo2js1,"Halo Scenario 1, >=2 Jets");
		subsub_folder = sub_folder->AddFolder("PhiWedge0_23","PhiWedge0_23");
		BookPhiWedgeHistograms(halo2js1pw023,subsub_folder,"Halo Scenario 1, >=2 Jets, #Phi wedge 0,23");
		subsub_folder = sub_folder->AddFolder("PhiWedge1_22","PhiWedge1_22");
		BookPhiWedgeHistograms(halo2js1pw122,subsub_folder,"Halo Scenario 1, >=2 Jets, #Phi wedge 1-22");
	
		sub_folder = new_folder->AddFolder("Scene2","Scene2");
		HistoMan.GetHaloHistograms(sub_folder,halo2js2,"Halo Scenario 2, >=2 Jets");
		subsub_folder = sub_folder->AddFolder("PhiWedge0_23","PhiWedge0_23");
		BookPhiWedgeHistograms(halo2js2pw023,subsub_folder,"Halo Scenario 2, >=2 Jets, #Phi wedge 0,23");
		subsub_folder = sub_folder->AddFolder("PhiWedge1_22","PhiWedge1_22");
		BookPhiWedgeHistograms(halo2js2pw122,subsub_folder,"Halo Scenario 2, >=2 Jets, #Phi wedge 1-22");
	
		sub_folder = new_folder->AddFolder("Scene3","Scene3");
		HistoMan.GetHaloHistograms(sub_folder,halo2js3,"Halo Scenario 3, >=2 Jets");
		subsub_folder = sub_folder->AddFolder("PhiWedge0_23","PhiWedge0_23");
		BookPhiWedgeHistograms(halo2js3pw023,subsub_folder,"Halo Scenario 3, >=2 Jets, #Phi wedge 0,23");
		subsub_folder = sub_folder->AddFolder("PhiWedge1_22","PhiWedge1_22");
		BookPhiWedgeHistograms(halo2js3pw122,subsub_folder,"Halo Scenario 3, >=2 Jets, #Phi wedge 1-22");
	
		sub_folder = new_folder->AddFolder("Scene4","Scene4");
		HistoMan.GetHaloHistograms(sub_folder,halo2js4,"Halo Scenario 4, >=2 Jets");
		subsub_folder = sub_folder->AddFolder("PhiWedge0_23","PhiWedge0_23");
		BookPhiWedgeHistograms(halo2js4pw023,subsub_folder,"Halo Scenario 4, >=2 Jets, #Phi wedge 0,23");
		subsub_folder = sub_folder->AddFolder("PhiWedge1_22","PhiWedge1_22");
		BookPhiWedgeHistograms(halo2js4pw122,subsub_folder,"Halo Scenario 4, >=2 Jets, #Phi wedge 1-22");
	
		sub_folder = new_folder->AddFolder("Scene5","Scene5");
		HistoMan.GetHaloHistograms(sub_folder,halo2js5,"Halo Scenario 5, >=2 Jets");
		subsub_folder = sub_folder->AddFolder("PhiWedge0_23","PhiWedge0_23");
		BookPhiWedgeHistograms(halo2js5pw023,subsub_folder,"Halo Scenario 5, >=2 Jets, #Phi wedge 0,23");
		subsub_folder = sub_folder->AddFolder("PhiWedge1_22","PhiWedge1_22");
		BookPhiWedgeHistograms(halo2js5pw122,subsub_folder,"Halo Scenario 5, >=2 Jets, #Phi wedge 1-22");

	
		new_folder = GetHistFolder(this, "CountingRoom","Counting Histograms");
		vCounterHistLabels.push_back("Events Processed");
		vCounterHistLabels.push_back("Events Passed");
		vCounterHistLabels.push_back("1 Jet Events");
		vCounterHistLabels.push_back("2 Jets Events");
		HistoMan.GetCounterHistograms(new_folder,hCount,this->GetName(),vCounterHistLabels);



	}
	
	BookEvtHistograms(aHaloByCut,"HaloByCut","Beam Halos By Id Cuts");


}


//_____________________________________________________________________________
int HaloEstimate::BeginJob()
{
  	initSpMod = (InitSuperPhotons*) ((TStnAna*) GetAna()->GetModule("InitSuperPhotons"));
	if (!initSpMod) {
		StdOut(__FILE__,__LINE__,3,"InitSuperPhotons module required!.");
		bRunPermit = false;
	}

  	jetMod = (TMyJetFilterModule*) ((TStnAna*) GetAna()->GetModule("MyJetFilter"));
	if (!jetMod) {
		StdOut(__FILE__,__LINE__,3,"JetFilter module required!.");
		bRunPermit = false;
	}

  	tightMod = (TagTightPhotons*) ((TStnAna*) GetAna()->GetModule("TagTightPhotons"));
	if (!tightMod) {
		StdOut(__FILE__,__LINE__,2,"TightPhoton tag module not found.");
		bRunPermit = false;
	}
  	haloMod = (TagBeamHalo*) ((TStnAna*) GetAna()->GetModule("TagBeamHalo"));
	if (!haloMod) {
		StdOut(__FILE__,__LINE__,2,"Halo tag module not found.");
		bRunPermit = false;
	}



				// register the data blocks
	fHeaderBlock 	= (TStnHeaderBlock*)   RegisterDataBlock("HeaderBlock","TStnHeaderBlock");

	BookHistograms();

	// initialize vars
	counter.evtsRunOver 			= 0;
	counter.evtsPassModule 		= 0;
	counter.haloEvtsFound 		= 0;

	return 0;
}

//_____________________________________________________________________________
int HaloEstimate::BeginRun()
{

	int currRun =  fHeaderBlock->RunNumber();
	//std::cout << " BEGINING RUN# " << currRun << std::endl;
	
	if (fHeaderBlock->McFlag()) 
   	qMc = true;
	else
   	qMc = false;
  
	return 0;

} //BeginRun

/*-------------------------------------------------------------------*/
/*-------------------------------------------------------------------*/
int HaloEstimate::Event(int ientry)
{
	// Event  loop

	SetPassed(1);
	if (!bRunPermit) {
		StdOut(__FILE__,__LINE__,2,"Run Permit Failed. One or more dependencies or requirements not met.");
		exit (1);
		return 0;
	}


	counter.evtsRunOver++;
	hCount.iCounter->Fill(0);
  
  	int NsuperPho = initSpMod->GetSuperPhoSize();
	float fMetCor = jetMod->GetMyMetCorr(0,3);		//cone0.4, Et>15GeV
	// number of jet requirement and pass accordingly. so I'll not check for that.
	bool b1Jetdone = false;		// to make sure an event is counted once even if there are 
	bool b2Jetdone = false;		// multiple candidates from same event. even if we remove this
										// the number would be small, i guess. but this is not true with
										// electrons.
	
	for (int i=0; i < NsuperPho; i++) {
		if (! initSpMod->GetSuperPhoton(i)->IsTight()) continue;
		if (! initSpMod->GetSuperPhoton(i)->IsBeamHalo()) continue;
		if (fabs(initSpMod->GetSuperPhoton(i)->GetEmTime()) > 4.8) continue;		//cut on em time
		counter.haloEvtsFound++;
		FillHistograms(aHaloByCut, initSpMod->GetSuperPhoton(i));

		int iHaloId =  initSpMod->GetSuperPhoton(i)->GetBeamHaloId();
		int iPhiSeedIndex = initSpMod->GetSuperPhoton(i)->GetPhoton()->PhiSeedIndex();
		
		//now look at each diff scenario with 1jet and 2jets
		if (jetMod->GetMyNjet(0,3) >= 1) {
			if (! b1Jetdone) {
				hCount.iCounter->Fill(2);
				b1Jetdone = true;
			}
			if ((iHaloId>>0) & 0x1) {
				//this  FREE function is in TagBeamHalo. should move it to FreeFunctions.hh/cc
				FillHaloHistograms(halo1js0,haloMod->GetHaloStuff(i),
										initSpMod->GetSuperPhoton(i)->GetPhoton());

				if (iPhiSeedIndex == 0 || iPhiSeedIndex == 23 ) {
					FillPhiWedgeHistogram(halo1js0pw023, initSpMod->GetSuperPhoton(i));
				} else {
					FillPhiWedgeHistogram(halo1js0pw122, initSpMod->GetSuperPhoton(i));
				}
				
			} //halo scenario=0
			
			if ((iHaloId>>1) & 0x1) {
				FillHaloHistograms(halo1js1,haloMod->GetHaloStuff(i),
										initSpMod->GetSuperPhoton(i)->GetPhoton());

				if (iPhiSeedIndex == 0 || iPhiSeedIndex == 23 ) {
					FillPhiWedgeHistogram(halo1js1pw023, initSpMod->GetSuperPhoton(i));
				} else {
					FillPhiWedgeHistogram(halo1js1pw122, initSpMod->GetSuperPhoton(i));
				}
			}
			if ((iHaloId>>2) & 0x1) {
				FillHaloHistograms(halo1js2,haloMod->GetHaloStuff(i),
										initSpMod->GetSuperPhoton(i)->GetPhoton());

				if (iPhiSeedIndex == 0 || iPhiSeedIndex == 23 ) {
					FillPhiWedgeHistogram(halo1js2pw023, initSpMod->GetSuperPhoton(i));
				} else {
					FillPhiWedgeHistogram(halo1js2pw122, initSpMod->GetSuperPhoton(i));
				}
			}
			if ((iHaloId>>3) & 0x1) {
				FillHaloHistograms(halo1js3,haloMod->GetHaloStuff(i),
										initSpMod->GetSuperPhoton(i)->GetPhoton());

				if (iPhiSeedIndex == 0 || iPhiSeedIndex == 23 ) {
					FillPhiWedgeHistogram(halo1js3pw023, initSpMod->GetSuperPhoton(i));
				} else {
					FillPhiWedgeHistogram(halo1js3pw122, initSpMod->GetSuperPhoton(i));
				}

			}
			if ((iHaloId>>4) & 0x1) {
				FillHaloHistograms(halo1js4,haloMod->GetHaloStuff(i),
										initSpMod->GetSuperPhoton(i)->GetPhoton());

				if (iPhiSeedIndex == 0 || iPhiSeedIndex == 23 ) {
					FillPhiWedgeHistogram(halo1js4pw023, initSpMod->GetSuperPhoton(i));
				} else {
					FillPhiWedgeHistogram(halo1js4pw122, initSpMod->GetSuperPhoton(i));
				}

			}
			if ((iHaloId>>5) & 0x1) {
				FillHaloHistograms(halo1js5,haloMod->GetHaloStuff(i),
										initSpMod->GetSuperPhoton(i)->GetPhoton());

				if (iPhiSeedIndex == 0 || iPhiSeedIndex == 23 ) {
					FillPhiWedgeHistogram(halo1js5pw023, initSpMod->GetSuperPhoton(i));
				} else {
					FillPhiWedgeHistogram(halo1js5pw122, initSpMod->GetSuperPhoton(i));
				}

			}
			
		
		} // end  >=1 Jets case
		
		if (jetMod->GetMyNjet(0,3) >= 2) {
			if (! b2Jetdone) {
				hCount.iCounter->Fill(3);
				b2Jetdone = true;
			}
			
			if ((iHaloId>>0) & 0x1) {
				FillHaloHistograms(halo2js0,haloMod->GetHaloStuff(i),
										initSpMod->GetSuperPhoton(i)->GetPhoton());

				if (iPhiSeedIndex == 0 || iPhiSeedIndex == 23 ) {
					FillPhiWedgeHistogram(halo2js0pw023, initSpMod->GetSuperPhoton(i));
				} else {
					FillPhiWedgeHistogram(halo2js0pw122, initSpMod->GetSuperPhoton(i));
				}

			}
			
			if ((iHaloId>>1) & 0x1) {
				FillHaloHistograms(halo2js1,haloMod->GetHaloStuff(i),
										initSpMod->GetSuperPhoton(i)->GetPhoton());

				if (iPhiSeedIndex == 0 || iPhiSeedIndex == 23 ) {
					FillPhiWedgeHistogram(halo2js1pw023, initSpMod->GetSuperPhoton(i));
				} else {
					FillPhiWedgeHistogram(halo2js1pw122, initSpMod->GetSuperPhoton(i));
				}

			}
			if ((iHaloId>>2) & 0x1) {
				FillHaloHistograms(halo2js2,haloMod->GetHaloStuff(i),
										initSpMod->GetSuperPhoton(i)->GetPhoton());

				if (iPhiSeedIndex == 0 || iPhiSeedIndex == 23 ) {
					FillPhiWedgeHistogram(halo2js2pw023, initSpMod->GetSuperPhoton(i));
				} else {
					FillPhiWedgeHistogram(halo2js2pw122, initSpMod->GetSuperPhoton(i));
				}

			}
			if ((iHaloId>>3) & 0x1) {
				FillHaloHistograms(halo2js3,haloMod->GetHaloStuff(i),
										initSpMod->GetSuperPhoton(i)->GetPhoton());

				if (iPhiSeedIndex == 0 || iPhiSeedIndex == 23 ) {
					FillPhiWedgeHistogram(halo2js3pw023, initSpMod->GetSuperPhoton(i));
				} else {
					FillPhiWedgeHistogram(halo2js3pw122, initSpMod->GetSuperPhoton(i));
				}

			}
			if ((iHaloId>>4) & 0x1) {
				FillHaloHistograms(halo2js4,haloMod->GetHaloStuff(i),
										initSpMod->GetSuperPhoton(i)->GetPhoton());

				if (iPhiSeedIndex == 0 || iPhiSeedIndex == 23 ) {
					FillPhiWedgeHistogram(halo2js4pw023, initSpMod->GetSuperPhoton(i));
				} else {
					FillPhiWedgeHistogram(halo2js4pw122, initSpMod->GetSuperPhoton(i));
				}

			}
			if ((iHaloId>>5) & 0x1) {
				FillHaloHistograms(halo2js5,haloMod->GetHaloStuff(i),
										initSpMod->GetSuperPhoton(i)->GetPhoton());

				if (iPhiSeedIndex == 0 || iPhiSeedIndex == 23 ) {
					FillPhiWedgeHistogram(halo2js5pw023, initSpMod->GetSuperPhoton(i));
				} else {
					FillPhiWedgeHistogram(halo2js5pw122, initSpMod->GetSuperPhoton(i));
				}

			}
		
		}// di-jet case:
	
		break; // don't care about rest of the photons
				// and to avoid mutiple entries to met/sumet plots
	}

	if (GetPassed()) {
		counter.evtsPassModule++;
		hCount.iCounter->Fill(1);
	}
	
	return 0;

} // Event


/*-------------------------------------------------------------------*/
// clean and clear things for the run
/*-------------------------------------------------------------------*/
void HaloEstimate::Cleanup()
{

} //Cleanup


/*-------------------------------------------------------------------*/
void HaloEstimate::FillDataBlocks(int ientry)
{
}
/*-------------------------------------------------------------------*/
/*-------------------------------------------------------------------*/
void HaloEstimate::FillPhiWedgeHistogram(PhiWedgeHist_t& Hist, SuperPhoton* sp)
{
	if (!sp) {
		StdErr(__FILE__,__LINE__,3,"SuperPhoton Pointer is NULL. No histograms are filled.");
		return;
	}

	float fMetCor = jetMod->GetMyMetCorr(0,3);		//cone0.4, Et>15GeV
	Hist.Met->Fill(fMetCor);
	if (fMetCor!=0) Hist.PhoEtMetRatio->Fill(fMetCor/sp->GetEtCorr());

	float fPhoPhi = TVector2::Phi_0_2pi(sp->GetCorVec().Phi());	// TLorentzVector return Phi from -pi to +pi
	float fMetPhi = jetMod->GetMyMetPhiCorr(0,3); 			// return Phi from 0 to 2pi
	Hist.PhoMetDelPhi->Fill(fabs(DelPhi(fPhoPhi,fMetPhi)));	// call from FreeFunctions.hh
	Hist.PhoEmTime->Fill(sp->GetEmTime());
	Hist.MetPhi->Fill(fMetPhi);
	Hist.PhoPhi->Fill(fPhoPhi);
}
/*-------------------------------------------------------------------*/
/*-------------------------------------------------------------------*/
void HaloEstimate::BookPhiWedgeHistograms(PhiWedgeHist_t& Hist,
										TFolder* new_folder, std::string text2add) 
{
	if (!new_folder) {
		StdErr(__FILE__,__LINE__,3,"Histogram Folder returned NULL. No histograms are added.");
		return;
	}
	char name [200];
	char title[200];
	char ytitle[200];

	sprintf(name,"EvtMet");
	sprintf(title,"%s - Event Met", text2add.c_str());
	Hist.Met = new TH1F(name,title,1200,0,1200);
	Hist.Met->GetXaxis()->SetTitle("ME_{T}^{(corr)} (GeV)");
	sprintf(ytitle,"Events / %3.3d", Hist.Met->GetBinWidth(1));
	Hist.Met->GetYaxis()->SetTitle(ytitle);
	new_folder->Add(Hist.Met);


	sprintf(name,"PhoMetDelPhi");
	sprintf(title,"%s - #Delta #Phi of #gamma & ME_{T}", text2add.c_str());
	Hist.PhoMetDelPhi = new TH1F(name,title,320,-8,8);
	Hist.PhoMetDelPhi->GetXaxis()->SetTitle("#Delta #Phi");
	sprintf(ytitle,"Events / %3.3f", Hist.PhoMetDelPhi->GetBinWidth(1));
	Hist.PhoMetDelPhi->GetYaxis()->SetTitle(ytitle);
	new_folder->Add(Hist.PhoMetDelPhi);

	sprintf(name,"PhoEtMetRatio");
	sprintf(title,"%s - ME_{T}/E_{T}^{#gamma}", text2add.c_str());
	Hist.PhoEtMetRatio = new TH1F(name,title,320,-8,8);
	Hist.PhoEtMetRatio->GetXaxis()->SetTitle("ME_{T}/E_{T}^{#gamma}");
	sprintf(ytitle,"Events / %3.3f", Hist.PhoEtMetRatio->GetBinWidth(1));
	Hist.PhoEtMetRatio->GetYaxis()->SetTitle(ytitle);
	new_folder->Add(Hist.PhoEtMetRatio);

	sprintf(name,"PhoTime");
	sprintf(title,"%s - Em Time Time", text2add.c_str());
	Hist.PhoEmTime=new TH1F(name,title,480,-80.0,160.0);
	Hist.PhoEmTime->GetXaxis()->SetTitle("EM Time (ns)");
	sprintf(ytitle,"Events / %3.3f", Hist.PhoEmTime->GetBinWidth(1));
	Hist.PhoEmTime->GetYaxis()->SetTitle(ytitle);
	new_folder->Add(Hist.PhoEmTime);
	
	sprintf(name,"MetPhi");
	sprintf(title,"%s - ME_{T} #Phi", text2add.c_str());
	Hist.MetPhi = new TH1F(name,title,320,-8,8);
	Hist.MetPhi->GetXaxis()->SetTitle("#Phi");
	sprintf(ytitle,"Events / %3.3f", Hist.MetPhi->GetBinWidth(1));
	Hist.MetPhi->GetYaxis()->SetTitle(ytitle);
	new_folder->Add(Hist.MetPhi);

	sprintf(name,"PhoPhi");
	sprintf(title,"%s - ME_{T} #Phi", text2add.c_str());
	Hist.PhoPhi = new TH1F(name,title,320,-8,8);
	Hist.PhoPhi->GetXaxis()->SetTitle("#Phi");
	sprintf(ytitle,"Events / %3.3f", Hist.PhoPhi->GetBinWidth(1));
	Hist.PhoPhi->GetYaxis()->SetTitle(ytitle);
	new_folder->Add(Hist.PhoPhi);

}



/*-------------------------------------------------------------------*/
/*-------------------------------------------------------------------*/
void HaloEstimate::FillHistograms(EventHist_t& Hist, SuperPhoton* sp)
{
		Hist.PhoEmTime->Fill(sp->GetEmTime());
		Hist.PhoEmTimeVsRun->Fill(fHeaderBlock->RunNumber(), sp->GetEmTime());
		Hist.Met->Fill(jetMod->GetMyMetCorr(0,3));
		Hist.Sumet->Fill(jetMod->GetMySumEtCorr(0,3));
}

/*-------------------------------------------------------------------*/
/*-------------------------------------------------------------------*/
void HaloEstimate::BookEvtHistograms(EventHist_t& Hist,
										std::string sFoldName, std::string text2add) 
{
	
	TFolder* new_folder = GetHistFolder(this, sFoldName,sFoldName);
	if (!new_folder) {
		StdErr(__FILE__,__LINE__,3,"Request for a new Histogram Folder returned NULL. No histograms are added.");
		return;
	}
  char name [200];
  char title[200];

  sprintf(name,"PhoTime");
  sprintf(title,"%s - Em Time Time", text2add.c_str());
  Hist.PhoEmTime=new TH1F(name,title,480,-80.0,160.0);
  new_folder->Add(Hist.PhoEmTime);

  sprintf(name,"PhoTimeVsRun");
  sprintf(title,"%s - Mean EM Times of #gamma (+2Jets>15GeV) Vs Run Number", text2add.c_str());
  Hist.PhoEmTimeVsRun = new TProfile(name,title,270000,130000,400000,-80,160);
  Hist.PhoEmTimeVsRun->GetXaxis()->SetTitle("Run Number");
  Hist.PhoEmTimeVsRun->GetYaxis()->SetTitle("Mean Em Times of Photons");
  new_folder->Add(Hist.PhoEmTimeVsRun);

  sprintf(name,"EvtMet");
  sprintf(title,"%s - Event Met", text2add.c_str());
  Hist.Met = new TH1F(name,title,1200,0,1200);
  Hist.Met->GetXaxis()->SetTitle("MEt(0) (GeV)");
  Hist.Met->GetYaxis()->SetTitle("Events/ 1 GeV");
  new_folder->Add(Hist.Met);


  sprintf(name,"EvtSumEt");
  sprintf(title,"%s - Event SumEt", text2add.c_str());
  Hist.Sumet = new TH1F(name,title,1200,0,1200);
  Hist.Sumet->GetXaxis()->SetTitle("SumEt(0) (GeV)");
  Hist.Sumet->GetYaxis()->SetTitle("Events/ 1 GeV");
  new_folder->Add(Hist.Sumet);

}

//_____________________________________________________________________________
//  END JOB SUMMARY
//_____________________________________________________________________________
int HaloEstimate::EndJob() {
	std::string modname = GetName();
	std::string msg;
	msg  = "[HET:00:]----- end job: ---- " + modname + "\n";
	msg += "[HET:01:] Events Run Over ------------ = " + ToStr(counter.evtsRunOver) + "\n";
	msg += "[HET:02:] Events Pass this module ---- = " + ToStr(counter.evtsPassModule) + "\n";
	msg += "[HET:03:] Halo Events Found ---------- = " + ToStr(counter.haloEvtsFound) + "\n";
	msg += "[HET:04:] Halo+ 1 Jet Events --------- = " + ToStr(hCount.iCounter->GetBinContent(3)) + "\n";
	msg += "[HET:05:] Halo+ 2 Jet Events --------- = " + ToStr(hCount.iCounter->GetBinContent(4)) + "\n";
	msg += "---------------------------------------------------\n";
	std::cout << msg;
	return 0;
}
